<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MallorcaEat â€“ Restaurant Explorer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background-color: #fdf6ec; }
    .card { transition: transform .15s, box-shadow .15s; }
    .card:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,.12); }
    .score-pill { font-size: 11px; line-height: 1; }
    .profile-btn.active { background: #c4622d; color: white; border-color: #c4622d; }
  </style>
</head>
<body class="min-h-screen">

<!-- â”€â”€ Header â”€â”€ -->
<header style="background: linear-gradient(135deg,#c4622d 0%,#e8954a 50%,#1a6b8a 100%)">
  <div class="max-w-7xl mx-auto px-4 py-7 text-white flex items-center gap-4">
    <span class="text-5xl">ğŸŒ´</span>
    <div>
      <h1 class="text-4xl font-extrabold tracking-tight">MallorcaEat</h1>
      <p class="text-white/75 text-lg mt-0.5">Die besten Restaurants auf Mallorca</p>
    </div>
  </div>
</header>

<!-- â”€â”€ Stats â”€â”€ -->
<div class="max-w-7xl mx-auto px-4 mt-6 grid grid-cols-2 sm:grid-cols-4 gap-4">
  <div class="bg-white rounded-2xl shadow p-5 text-center border-t-4 border-amber-400">
    <div class="text-3xl font-black text-amber-500">{{ total }}</div>
    <div class="text-gray-500 text-sm mt-1">Restaurants erfasst</div>
  </div>
  <div class="bg-white rounded-2xl shadow p-5 text-center border-t-4 border-orange-500">
    <div class="text-3xl font-black text-orange-500">{{ top_count }}</div>
    <div class="text-gray-500 text-sm mt-1">Top-Spots <span class="text-xs">(â‰¥4.5â˜… â‰¥100 Rez.)</span></div>
  </div>
  <div class="bg-white rounded-2xl shadow p-5 text-center border-t-4 border-sky-500">
    <div class="text-3xl font-black text-sky-600">{{ avg_rating }}</div>
    <div class="text-gray-500 text-sm mt-1">Ã˜ Bewertung</div>
  </div>
  <div class="bg-white rounded-2xl shadow p-5 text-center border-t-4 border-emerald-500">
    <div class="text-3xl font-black text-emerald-600">{{ enriched_count }}</div>
    <div class="text-gray-500 text-sm mt-1">KI-analysiert</div>
  </div>
</div>

<!-- â”€â”€ Profile Filter â”€â”€ -->
<div class="max-w-7xl mx-auto px-4 mt-5">
  <div class="bg-white rounded-2xl shadow p-4">
    <p class="text-xs text-gray-400 font-semibold uppercase tracking-wide mb-3">FÃ¼r wen planst du?</p>
    <div class="flex flex-wrap gap-2">
      <a href="{{ url_for('index', search=search, location=location) }}"
         class="profile-btn {{ 'active' if not profile_key else '' }} border rounded-full px-3 py-1.5 text-sm font-medium text-gray-600 border-gray-200 hover:border-orange-400 transition">
        Alle
      </a>
      {% for key, emoji, label in profiles %}
      <a href="{{ url_for('index', search=search, location=location, profile=key, min_score=min_score) }}"
         class="profile-btn {{ 'active' if profile_key == key else '' }} border rounded-full px-3 py-1.5 text-sm font-medium text-gray-600 border-gray-200 hover:border-orange-400 transition">
        {{ emoji }} {{ label }}
      </a>
      {% endfor %}
    </div>

    {% if profile_key %}
    <div class="mt-3 flex items-center gap-3">
      <span class="text-xs text-gray-400">Mindest-Score:</span>
      {% for s in [6, 7, 8, 9] %}
      <a href="{{ url_for('index', search=search, location=location, profile=profile_key, min_score=s) }}"
         class="text-xs px-2 py-1 rounded-full border {{ 'bg-orange-500 text-white border-orange-500' if min_score == s else 'border-gray-200 text-gray-500 hover:border-orange-400' }} transition">
        â‰¥ {{ s }}
      </a>
      {% endfor %}
    </div>
    {% endif %}
  </div>
</div>

<!-- â”€â”€ Search â”€â”€ -->
<div class="max-w-7xl mx-auto px-4 mt-4">
  <form method="get" class="bg-white rounded-2xl shadow p-4 flex flex-wrap gap-3 items-center">
    {% if profile_key %}<input type="hidden" name="profile" value="{{ profile_key }}">{% endif %}
    {% if min_score != 7 %}<input type="hidden" name="min_score" value="{{ min_score }}">{% endif %}
    <input type="text" name="search" value="{{ search }}"
           placeholder="ğŸ”  Restaurant suchen â€¦"
           class="flex-1 min-w-[180px] border border-gray-200 rounded-xl px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-amber-400">
    {% if locations %}
    <select name="location"
            class="border border-gray-200 rounded-xl px-3 py-2.5 text-sm bg-white focus:outline-none focus:ring-2 focus:ring-amber-400">
      <option value="">ğŸ“ Alle Orte</option>
      {% for loc in locations %}
      <option value="{{ loc }}" {% if loc == location %}selected{% endif %}>{{ loc }}</option>
      {% endfor %}
    </select>
    {% endif %}
    <button type="submit"
            class="bg-amber-500 hover:bg-amber-600 text-white font-semibold px-6 py-2.5 rounded-xl transition text-sm">
      Filtern
    </button>
    {% if search or location %}
    <a href="{{ url_for('index', profile=profile_key or '', min_score=min_score) }}"
       class="text-gray-400 hover:text-gray-600 text-sm px-1">âœ•</a>
    {% endif %}
  </form>
</div>

<!-- â”€â”€ Results â”€â”€ -->
<main class="max-w-7xl mx-auto px-4 py-5 pb-14">

  {% if error %}
  <div class="bg-red-50 border border-red-200 rounded-2xl p-10 text-center">
    <div class="text-5xl mb-3">âš ï¸</div>
    <h2 class="text-xl font-bold text-red-700">Datenbankfehler</h2>
    <pre class="mt-3 text-sm text-red-500 bg-red-100 rounded-xl p-4 text-left overflow-x-auto">{{ error }}</pre>
  </div>

  {% elif restaurants %}
  <p class="text-sm text-gray-400 mb-4">
    <strong class="text-gray-600">{{ restaurants|length }}</strong> Restaurant{% if restaurants|length != 1 %}s{% endif %}
    {% if profile_key %}
      {% for k, e, l in profiles %}{% if k == profile_key %} Â· gefiltert nach <strong>{{ e }} {{ l }}</strong> (Score â‰¥ {{ min_score }}){% endif %}{% endfor %}
    {% endif %}
    {% if search %} Â· Suche: â€<strong>{{ search }}</strong>"{% endif %}
  </p>

  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5">
    {% for r in restaurants %}

    {# collect profile scores for display #}
    {% set scores = [
      ("family",   "ğŸ‘¨â€ğŸ‘©â€ğŸ‘§", "Familie",    r.family_score),
      ("date",     "ğŸ’‘",    "Date Night", r.date_score),
      ("friends",  "ğŸ‘¯",    "Friends",    r.friends_score),
      ("solo",     "ğŸ§",    "Solo",       r.solo_score),
      ("relaxed",  "ğŸ˜Œ",    "Entspannt",  r.relaxed_score),
      ("party",    "ğŸ‰",    "Party",      r.party_score),
      ("special",  "âœ¨",    "Besonders",  r.special_score),
      ("foodie",   "ğŸ½ï¸",   "Foodie",     r.foodie_score),
      ("lingering","â˜•",    "Verweilen",  r.lingering_score),
      ("unique",   "ğŸ’",    "Geheimtipp", r.unique_score),
      ("dresscode","ğŸ‘”",    "Dress Code", r.dresscode_score),
    ] %}

    <div class="card bg-white rounded-2xl shadow overflow-hidden flex flex-col">

      <!-- Thumbnail -->
      {% if r.thumbnail_url %}
      <div class="h-44 overflow-hidden bg-gray-100">
        <img src="{{ r.thumbnail_url }}" alt="{{ r.name }}" class="w-full h-full object-cover">
      </div>
      {% else %}
      <div class="h-44 flex items-center justify-center text-5xl"
           style="background:linear-gradient(135deg,#fde68a,#fdba74)">ğŸ½ï¸</div>
      {% endif %}

      <div class="p-4 flex flex-col flex-1">

        <!-- Name + price -->
        <div class="flex justify-between items-start gap-2">
          <h3 class="font-bold text-gray-800 leading-snug">{{ r.name }}</h3>
          {% if r.price_level %}
          <span class="shrink-0 text-xs font-semibold text-green-700 bg-green-100 px-2 py-0.5 rounded-full">{{ r.price_level }}</span>
          {% endif %}
        </div>

        <!-- Vibe (Gemini one-liner) -->
        {% if r.vibe %}
        <p class="text-gray-500 text-xs italic mt-1 leading-snug">â€{{ r.vibe }}"</p>
        {% endif %}

        <!-- Stars + rating -->
        <div class="flex items-center mt-2 gap-1">
          {% for i in range(5) %}
          <span class="text-lg leading-none {{ 'text-amber-400' if i < r.rating|int else 'text-gray-200' }}">â˜…</span>
          {% endfor %}
          <span class="ml-1 font-bold text-gray-700 text-sm">{{ r.rating }}</span>
          <span class="text-gray-400 text-xs">({{ r.rating_count | int }})</span>
        </div>

        <!-- Categories -->
        {% if r.categories %}
        <div class="flex flex-wrap gap-1 mt-2">
          {% for cat in r.categories[:3] %}
          <span class="text-xs bg-amber-100 text-amber-700 px-2 py-0.5 rounded-full">{{ cat }}</span>
          {% endfor %}
        </div>
        {% endif %}

        <!-- Profile scores (only if enriched) -->
        {% if r.vibe %}
        <div class="mt-3 flex flex-wrap gap-1">
          {% for key, emoji, label, score in scores %}
          {% if score %}
          <span title="{{ label }}: {{ score }}/10"
                class="score-pill inline-flex items-center gap-0.5 px-2 py-1 rounded-full font-semibold
                       {{ 'bg-emerald-100 text-emerald-700' if score >= 8
                          else 'bg-amber-100 text-amber-700' if score >= 6
                          else 'bg-gray-100 text-gray-500' }}
                       {{ 'ring-2 ring-orange-400' if profile_key == key }}">
            {{ emoji }} {{ score }}
          </span>
          {% endif %}
          {% endfor %}
        </div>

        <!-- Must order -->
        {% if r.must_order %}
        <div class="mt-2 flex items-start gap-1.5">
          <span class="text-orange-500 text-sm shrink-0 mt-0.5">ğŸ´</span>
          <p class="text-xs text-gray-600 leading-snug">{{ r.must_order }}</p>
        </div>
        {% endif %}

        <!-- Summary (collapsible) -->
        {% if r.summary_de %}
        <details class="mt-2 group">
          <summary class="text-xs text-sky-600 cursor-pointer hover:text-sky-800 select-none list-none flex items-center gap-1">
            <span class="group-open:hidden">â–¶ Warum hingehen?</span>
            <span class="hidden group-open:inline">â–¼ Warum hingehen?</span>
          </summary>
          <p class="text-xs text-gray-500 mt-1 leading-relaxed">{{ r.summary_de }}</p>
        </details>
        {% endif %}
        {% endif %}

        <!-- Address + links -->
        {% if r.address %}
        <p class="text-gray-400 text-xs mt-3 leading-snug">ğŸ“ {{ r.address }}</p>
        {% endif %}
        <div class="mt-auto pt-3 flex gap-3 flex-wrap">
          {% if r.website %}
          <a href="{{ r.website }}" target="_blank" rel="noopener"
             class="text-xs text-sky-600 hover:underline font-medium">ğŸŒ Website</a>
          {% endif %}
          {% if r.phone %}
          <span class="text-xs text-gray-400">ğŸ“ {{ r.phone }}</span>
          {% endif %}
        </div>

      </div>
    </div>
    {% endfor %}
  </div>

  {% else %}
  <div class="bg-white rounded-2xl shadow p-14 text-center mt-4">
    <div class="text-7xl mb-4">ğŸ–ï¸</div>
    {% if profile_key %}
    <h2 class="text-2xl font-bold text-gray-700">Keine Treffer fÃ¼r dieses Profil</h2>
    <p class="text-gray-400 mt-2">Probiere einen niedrigeren Mindest-Score oder ein anderes Profil.</p>
    {% elif enriched_count == 0 %}
    <h2 class="text-2xl font-bold text-gray-700">Noch keine KI-Analysen vorhanden</h2>
    <p class="text-gray-400 mt-2">Starte den Enricher, um Restaurants mit Gemini zu analysieren:</p>
    <code class="block mt-4 bg-gray-50 border rounded-xl p-4 text-sm text-left max-w-lg mx-auto font-mono text-gray-600">
      docker compose --profile enrich run --rm enricher --limit 10 --dry-run
    </code>
    {% else %}
    <h2 class="text-2xl font-bold text-gray-700">Keine Restaurants gefunden</h2>
    <p class="text-gray-400 mt-2">Versuche andere Suchbegriffe oder Filter.</p>
    {% endif %}
  </div>
  {% endif %}

</main>
</body>
</html>
