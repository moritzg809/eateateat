<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MallorcaEat</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;0,900;1,700&family=Inter:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            ink:   '#0f0e0d',
            cream: '#f5f0e8',
            sand:  '#e8e0cc',
            terra: '#c4622d',
            rust:  '#9e3d14',
            sage:  '#3d5a47',
          },
          fontFamily: {
            serif: ['"Playfair Display"', 'Georgia', 'serif'],
            sans:  ['Inter', 'system-ui', 'sans-serif'],
            mono:  ['"DM Mono"', 'monospace'],
          }
        }
      }
    }
  </script>
  <style>
    body { background: #f5f0e8; color: #0f0e0d; }

    .card { transition: transform .2s ease, box-shadow .2s ease; }
    .card:hover { transform: translateY(-3px); box-shadow: 0 16px 40px rgba(15,14,13,.13); }

    .pill { transition: background .15s, color .15s, border-color .15s; }
    .pill.active { background: #f5f0e8; color: #0f0e0d; border-color: #f5f0e8; }

    .score-hi  { background: #d4edda; color: #1a5c2e; }
    .score-mid { background: #fff3cd; color: #7a5500; }
    .score-lo  { background: #ebebeb; color: #555; }
    .score-sel { outline: 2px solid #c4622d; outline-offset: 1px; }

    .filter-scroll { -ms-overflow-style: none; scrollbar-width: none; }
    .filter-scroll::-webkit-scrollbar { display: none; }

    @media (min-width: 1024px) {
      .card-featured { grid-column: span 2; }
      .card-featured .card-img { height: 340px; }
    }
  </style>
</head>
<body class="min-h-screen font-sans">

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<header class="bg-ink text-cream">
  <div class="max-w-7xl mx-auto px-5 pt-10 pb-8">

    <div class="flex items-center justify-between mb-8 border-b border-cream/20 pb-4">
      <span class="font-mono text-xs tracking-widest text-cream/40 uppercase">Restaurant Guide</span>
      <span class="font-mono text-xs text-cream/30">Mallorca ¬∑ Espa√±a</span>
    </div>

    <div class="flex flex-col lg:flex-row lg:items-end lg:justify-between gap-8">
      <div>
        <h1 class="font-serif text-[clamp(3.5rem,11vw,8rem)] leading-[.88] tracking-tight">
          Mallorca<br><em class="text-terra">Eat</em>
        </h1>
        <p class="mt-5 font-sans font-light text-cream/55 text-lg max-w-sm leading-relaxed">
          Die besten Tische der Insel ‚Äî kuratiert, bewertet, ehrlich.
        </p>
      </div>

      <div class="flex gap-8 shrink-0 pb-1">
        <div>
          <div class="font-serif text-5xl font-bold text-cream">{{ top_count }}</div>
          <div class="font-mono text-[10px] text-cream/35 uppercase tracking-widest mt-1">Top Spots</div>
        </div>
        <div class="w-px bg-cream/10"></div>
        <div>
          <div class="font-serif text-5xl font-bold text-terra">{{ enriched_count }}</div>
          <div class="font-mono text-[10px] text-cream/35 uppercase tracking-widest mt-1">KI-analysiert</div>
        </div>
        <div class="w-px bg-cream/10"></div>
        <div>
          <div class="font-serif text-5xl font-bold text-cream">{{ avg_rating }}</div>
          <div class="font-mono text-[10px] text-cream/35 uppercase tracking-widest mt-1">√ò Bewertung</div>
        </div>
      </div>
    </div>
  </div>
</header>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STICKY NAV FILTER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="bg-ink border-t border-cream/10 sticky top-0 z-30">
  <div class="max-w-7xl mx-auto px-5">
    <div class="filter-scroll flex gap-2 overflow-x-auto py-3">
      <a href="{{ url_for('index', search=search, location=location) }}"
         class="pill shrink-0 border border-cream/20 rounded-full px-4 py-1.5 font-mono text-xs text-cream/50 hover:border-cream/50 {{ 'active' if not profile_key and not view else '' }}">
        Alle
      </a>
      {% for key, emoji, label in profiles %}
      <a href="{{ url_for('index', search=search, location=location, profile=key, min_score=min_score) }}"
         class="pill shrink-0 border border-cream/20 rounded-full px-4 py-1.5 font-mono text-xs text-cream/50 hover:border-cream/50 {{ 'active' if profile_key == key else '' }}">
        {{ emoji }}&nbsp;{{ label }}
      </a>
      {% endfor %}
      <!-- Favoriten-Filter -->
      <span class="shrink-0 w-px bg-cream/10 mx-1"></span>
      <a href="{{ url_for('index', search=search, location=location, profile=profile_key or '', min_score=min_score, view='want') }}"
         class="pill shrink-0 border rounded-full px-4 py-1.5 font-mono text-xs transition
                {{ 'border-terra bg-terra/20 text-terra' if view == 'want' else 'border-cream/20 text-cream/50 hover:border-terra/50 hover:text-terra/70' }}">
        ü§ç&nbsp;Merkliste
      </a>
      <a href="{{ url_for('index', search=search, location=location, profile=profile_key or '', min_score=min_score, view='been') }}"
         class="pill shrink-0 border rounded-full px-4 py-1.5 font-mono text-xs transition
                {{ 'border-sage bg-sage/20 text-sage' if view == 'been' else 'border-cream/20 text-cream/50 hover:border-sage/50 hover:text-sage/70' }}">
        ‚úì&nbsp;War da
      </a>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SEARCH + SCORE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="max-w-7xl mx-auto px-5 mt-5 flex flex-wrap items-center gap-3">

  {% if profile_key %}
  <div class="flex items-center gap-1.5 bg-white rounded-xl px-3 py-2 shadow-sm border border-sand">
    <span class="font-mono text-[10px] text-ink/35 uppercase tracking-widest mr-1">Score ‚â•</span>
    {% for s in [6, 7, 8, 9] %}
    <a href="{{ url_for('index', search=search, location=location, profile=profile_key, min_score=s) }}"
       class="font-mono text-xs px-2.5 py-1 rounded-lg transition
              {{ 'bg-ink text-cream' if min_score == s else 'text-ink/40 hover:bg-sand' }}">
      {{ s }}
    </a>
    {% endfor %}
  </div>
  {% endif %}

  <form method="get" class="flex flex-1 min-w-[200px] items-center gap-2 bg-white rounded-xl px-3 py-2 shadow-sm border border-sand">
    {% if profile_key %}<input type="hidden" name="profile" value="{{ profile_key }}">{% endif %}
    {% if min_score != 7 %}<input type="hidden" name="min_score" value="{{ min_score }}">{% endif %}
    <span class="text-ink/25 text-base">‚åï</span>
    <input type="text" name="search" value="{{ search }}"
           placeholder="Restaurant suchen ‚Ä¶"
           class="flex-1 text-sm font-sans outline-none bg-transparent placeholder-ink/25">
    {% if locations %}
    <select name="location" class="text-sm font-sans text-ink/50 bg-transparent outline-none border-l border-sand pl-3">
      <option value="">Alle Orte</option>
      {% for loc in locations %}
      <option value="{{ loc }}" {% if loc == location %}selected{% endif %}>{{ loc }}</option>
      {% endfor %}
    </select>
    {% endif %}
    <button type="submit"
            class="bg-terra text-cream font-mono text-xs px-3 py-1.5 rounded-lg hover:bg-rust transition shrink-0">
      Los
    </button>
    {% if search or location %}
    <a href="{{ url_for('index', profile=profile_key or '', min_score=min_score) }}"
       class="text-ink/25 hover:text-ink/60 text-sm px-1">‚úï</a>
    {% endif %}
  </form>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MAIN GRID ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<main class="max-w-7xl mx-auto px-5 py-6 pb-20">

  {% if error %}
  <div class="bg-red-50 border border-red-200 rounded-2xl p-10 text-center">
    <div class="font-serif text-5xl mb-3 text-red-300">!</div>
    <h2 class="font-serif text-xl font-bold text-red-700">Datenbankfehler</h2>
    <pre class="mt-3 text-sm text-red-500 bg-red-100 rounded-xl p-4 text-left overflow-x-auto font-mono">{{ error }}</pre>
  </div>

  {% elif restaurants %}

  <!-- Count / filter label -->
  <div class="flex items-center gap-4 mb-6 pt-2">
    <div class="flex-1 border-t border-ink/10"></div>
    <span class="font-mono text-[11px] text-ink/35 uppercase tracking-widest whitespace-nowrap">
      {{ total_filtered }} Restaurant{% if total_filtered != 1 %}s{% endif %}
      {% if total_pages > 1 %} ¬∑ Seite {{ page }}/{{ total_pages }}{% endif %}
      {% if profile_key %}{% for k, e, l in profiles %}{% if k == profile_key %} ¬∑ {{ e }} {{ l }} ‚â• {{ min_score }}{% endif %}{% endfor %}{% endif %}
      {% if search %} ¬∑ ‚Äû{{ search }}"{% endif %}
    </span>
    <div class="flex-1 border-t border-ink/10"></div>
  </div>

  <!-- Cards -->
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5">
    {% for r in restaurants %}

    {% set scores = [
      ("family",    "üë®‚Äçüë©‚Äçüëß", "Familie",    r.family_score),
      ("date",      "üíë",    "Date Night", r.date_score),
      ("friends",   "üëØ",    "Friends",    r.friends_score),
      ("solo",      "üßç",    "Solo",       r.solo_score),
      ("relaxed",   "üòå",    "Entspannt",  r.relaxed_score),
      ("party",     "üéâ",    "Party",      r.party_score),
      ("special",   "‚ú®",    "Besonders",  r.special_score),
      ("foodie",    "üçΩÔ∏è",   "Foodie",     r.foodie_score),
      ("lingering", "‚òï",    "Verweilen",  r.lingering_score),
      ("unique",    "üíé",    "Geheimtipp", r.unique_score),
      ("dresscode", "üëî",    "Dress Code", r.dresscode_score),
    ] %}

    <div class="card group bg-white rounded-2xl overflow-hidden flex flex-col border border-sand {{ 'card-featured' if loop.first else '' }}"
         data-place-id="{{ r.place_id }}"
         data-fav-type="{{ r.fav_type or '' }}">

      <!-- Image carousel -->
      <div class="card-img relative h-52 overflow-hidden bg-gradient-to-br from-sand to-stone-100 group" id="c{{ loop.index }}" data-idx="0">
        <!-- Emoji fallback ‚Äî always rendered behind photos, visible when images fail or are absent -->
        <div class="absolute inset-0 flex items-center justify-center pointer-events-none select-none z-0">
          <span class="text-7xl opacity-20">{{ r.type_emoji }}</span>
        </div>

        <!-- Favoriten-Buttons (top-left) -->
        <div class="absolute top-2 left-2 flex gap-1.5 z-20">
          <button data-fav-btn="want"
                  onclick="toggleFav(event,'{{ r.place_id }}','want')"
                  title="Da m√∂chte ich hin"
                  class="w-8 h-8 rounded-full flex items-center justify-center text-base backdrop-blur-sm transition-all
                         {{ 'bg-terra text-cream shadow-md' if r.fav_type == 'want' else 'bg-ink/40 text-cream/70 hover:bg-terra/80 hover:text-cream' }}">
            {{ 'ü§ç' if r.fav_type != 'want' else '‚ù§Ô∏è' }}
          </button>
          <button data-fav-btn="been"
                  onclick="toggleFav(event,'{{ r.place_id }}','been')"
                  title="Da war ich"
                  class="w-8 h-8 rounded-full flex items-center justify-center text-base backdrop-blur-sm transition-all
                         {{ 'bg-sage text-cream shadow-md' if r.fav_type == 'been' else 'bg-ink/40 text-cream/70 hover:bg-sage/80 hover:text-cream' }}">
            {{ '‚úì' if r.fav_type == 'been' else '‚óã' }}
          </button>
          {% if r.fav_type == 'been' and r.fav_score is not none %}
          <span data-fav-score
                class="bg-sage text-cream font-mono text-[11px] font-bold px-2 py-0.5 rounded-full flex items-center shadow-md">
            {{ r.fav_score }}
          </span>
          {% else %}
          <span data-fav-score class="hidden bg-sage text-cream font-mono text-[11px] font-bold px-2 py-0.5 rounded-full flex items-center shadow-md"></span>
          {% endif %}
        </div>

        {% if r.photos %}
        <!-- Photo strip: all images in a flex row, JS moves translateX -->
        <div class="flex h-full relative z-10" data-strip style="transition:transform .3s ease">
          {% for photo in r.photos %}
          <img src="{{ photo }}" alt="{{ r.name }}"
               class="shrink-0 object-cover"
               style="min-width:100%;width:100%"
               loading="lazy"
               onerror="this.style.display='none'">
          {% endfor %}
        </div>

        {% if r.photos|length > 1 %}
        <!-- Prev arrow -->
        <button onclick="moveC('c{{ loop.index }}',-1);event.stopPropagation()"
                class="absolute left-2 top-1/2 -translate-y-1/2
                       w-7 h-7 rounded-full bg-ink/55 text-cream text-base leading-none
                       flex items-center justify-center
                       opacity-0 group-hover:opacity-100 transition-opacity
                       hover:bg-ink/80 focus:outline-none z-20">
          ‚Äπ
        </button>
        <!-- Next arrow -->
        <button onclick="moveC('c{{ loop.index }}',1);event.stopPropagation()"
                class="absolute right-2 top-1/2 -translate-y-1/2
                       w-7 h-7 rounded-full bg-ink/55 text-cream text-base leading-none
                       flex items-center justify-center
                       opacity-0 group-hover:opacity-100 transition-opacity
                       hover:bg-ink/80 focus:outline-none z-20">
          ‚Ä∫
        </button>
        <!-- Dot indicators -->
        <div class="absolute bottom-2 left-1/2 -translate-x-1/2 flex gap-1 pointer-events-none z-20" data-dots>
          {% for photo in r.photos %}
          <span class="block w-1.5 h-1.5 rounded-full bg-white transition-opacity
                       {% if loop.first %}opacity-90{% else %}opacity-30{% endif %}"></span>
          {% endfor %}
        </div>
        {% endif %}
        {% endif %}

        {% if r.price_level %}
        <span class="absolute top-3 right-3 font-mono text-xs bg-ink/75 text-cream px-2.5 py-0.5 rounded-full backdrop-blur-sm z-20">{{ r.price_level }}</span>
        {% endif %}
      </div>
      {% if false %}{# old else branch kept for reference ‚Äî now unused #}
      <div class="card-img h-52 bg-gradient-to-br from-sand to-cream flex items-center justify-center relative">
        <span class="text-5xl opacity-30">üçΩÔ∏è</span>
        {% if r.price_level %}
        <span class="absolute top-3 right-3 font-mono text-xs bg-ink text-cream px-2 py-0.5 rounded-full">{{ r.price_level }}</span>
        {% endif %}
      </div>
      {% endif %}

      <!-- Body -->
      <div class="p-5 flex flex-col flex-1">

        <!-- Name + rating -->
        <div class="flex items-start justify-between gap-2 mb-2">
          <h3 class="font-serif text-xl font-bold text-ink leading-tight">{{ r.name }}</h3>
          <div class="shrink-0 flex items-center gap-1 bg-ink text-cream rounded-full pl-2.5 pr-2.5 py-0.5">
            <span class="font-mono text-xs font-bold
              {% if (r.rating * 20)|round|int >= 94 %}text-green-400
              {% elif (r.rating * 20)|round|int >= 88 %}text-terra
              {% else %}text-cream/70{% endif %}">
              {{ (r.rating * 20)|round|int }}
            </span>
            <span class="font-mono text-[9px] text-cream/35">/100</span>
          </div>
        </div>

        <!-- City ¬∑ type ¬∑ review count -->
        <div class="flex items-center gap-2 flex-wrap mb-3">
          {% if r.city %}
          <span class="font-mono text-[10px] text-ink/45 flex items-center gap-0.5">
            <svg class="inline w-2.5 h-2.5 opacity-50 shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/></svg>
            {{ r.city }}
          </span>
          {% endif %}
          <span class="font-mono text-[10px] text-terra/70 border border-terra/20 bg-terra/5 px-2 py-0.5 rounded-full leading-none">{{ r.type_emoji }} {{ r.type_label }}</span>
          <span class="font-mono text-[10px] text-ink/25 ml-auto">{{ r.rating_count | int }} ‚ú¶</span>
        </div>

        <!-- Vibe -->
        {% if r.vibe %}
        <p class="font-sans text-xs italic text-ink/50 leading-snug mb-3 line-clamp-2">‚Äû{{ r.vibe }}"</p>
        {% endif %}

        <!-- Atmosphere + highlight tags (SerpAPI) -->
        {% if r.atmosphere or r.highlights %}
        <div class="flex flex-wrap gap-1 mb-3">
          {% for tag in (r.atmosphere or [])[:3] %}
          <span class="font-mono text-[10px] text-ink/45 bg-sand/50 border border-sand px-2 py-0.5 rounded-full">{{ tag }}</span>
          {% endfor %}
          {% for tag in (r.highlights or [])[:2] %}
          <span class="font-mono text-[10px] text-sage/80 border border-sage/20 bg-sage/5 px-2 py-0.5 rounded-full">‚ú¶ {{ tag }}</span>
          {% endfor %}
        </div>
        {% elif r.categories %}
        <div class="flex flex-wrap gap-1 mb-3">
          {% for cat in r.categories[:3] %}
          <span class="font-mono text-[10px] uppercase tracking-wide text-terra/70 border border-terra/15 px-2 py-0.5 rounded-full">{{ cat }}</span>
          {% endfor %}
        </div>
        {% endif %}

        <!-- Profile scores -->
        {% if r.vibe %}
        <div class="flex flex-wrap gap-1 mb-3">
          {% for key, emoji, label, score in scores %}
          {% if score %}
          <span title="{{ label }}: {{ score }}/10"
                class="font-mono text-[10px] px-2 py-0.5 rounded-full font-medium
                       {{ 'score-hi' if score >= 8 else 'score-mid' if score >= 6 else 'score-lo' }}
                       {{ 'score-sel' if profile_key == key }}">
            {{ emoji }} {{ score }}
          </span>
          {% endif %}
          {% endfor %}
        </div>

        <!-- Must order -->
        {% if r.must_order %}
        <div class="flex items-start gap-1.5 mb-2">
          <span class="text-terra text-xs shrink-0 mt-0.5">üç¥</span>
          <p class="font-sans text-xs text-ink/60 leading-snug">{{ r.must_order }}</p>
        </div>
        {% endif %}

        <!-- Collapsible: summary + popular_for + offerings -->
        {% if r.summary_de or r.popular_for or r.offerings %}
        <details class="mt-1 group">
          <summary class="font-mono text-[10px] uppercase tracking-widest text-terra/70 cursor-pointer hover:text-terra select-none list-none flex items-center gap-1">
            <span class="group-open:hidden">‚ñ∏ Mehr erfahren</span>
            <span class="hidden group-open:inline">‚ñæ Weniger</span>
          </summary>
          <div class="mt-2 space-y-2">
            {% if r.summary_de %}
            <p class="font-sans text-xs text-ink/55 leading-relaxed border-l-2 border-terra/25 pl-3">{{ r.summary_de }}</p>
            {% endif %}
            {% if r.popular_for %}
            <div class="flex flex-wrap gap-1">
              {% for t in r.popular_for %}
              <span class="font-mono text-[10px] bg-cream border border-sand px-2 py-0.5 rounded-full text-ink/55">üïê {{ t }}</span>
              {% endfor %}
            </div>
            {% endif %}
            {% if r.offerings %}
            <div class="flex flex-wrap gap-1">
              {% for t in (r.offerings or [])[:8] %}
              <span class="font-mono text-[10px] bg-cream border border-sand px-2 py-0.5 rounded-full text-ink/55">üçπ {{ t }}</span>
              {% endfor %}
            </div>
            {% endif %}
          </div>
        </details>
        {% endif %}
        {% endif %}

        <div class="flex-1"></div>

        <!-- Footer -->
        <div class="mt-4 pt-3 border-t border-sand flex items-center justify-between gap-2 flex-wrap">
          {% if r.address %}
          <p class="font-mono text-[10px] text-ink/30 leading-snug flex-1 min-w-0 truncate">
            üìç {{ r.address.split(',')[0] }}
          </p>
          {% endif %}
          <div class="flex gap-3 shrink-0 items-center">
            <button data-sim-id="{{ r.place_id }}" data-sim-name="{{ r.name | e }}"
                    onclick="showSimilar(this.dataset.simId, this.dataset.simName)"
                    class="font-mono text-[10px] text-ink/35 hover:text-terra uppercase tracking-wide transition-colors">
              ‚âà √Ñhnliche
            </button>
            {% if r.website %}
            <a href="{{ r.website }}" target="_blank" rel="noopener"
               class="font-mono text-[10px] text-terra hover:text-rust uppercase tracking-wide">Web ‚Üó</a>
            {% endif %}
          </div>
        </div>

      </div>
    </div>
    {% endfor %}
  </div>

  <!-- ‚ïê‚ïê‚ïê PAGINATION ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  {% if total_pages > 1 %}
  {% set base_args = [] %}
  {% if search %}{% set base_args = base_args + ['search=' ~ search] %}{% endif %}
  {% if location %}{% set base_args = base_args + ['location=' ~ location] %}{% endif %}
  {% if profile_key %}{% set base_args = base_args + ['profile=' ~ profile_key, 'min_score=' ~ min_score] %}{% endif %}
  {% if view %}{% set base_args = base_args + ['view=' ~ view] %}{% endif %}
  {% set base_qs = base_args | join('&') %}

  <nav class="flex items-center justify-center gap-2 mt-10 mb-4 flex-wrap">

    {# Prev button #}
    {% if page > 1 %}
    <a href="?{{ base_qs }}{% if base_qs %}&{% endif %}page={{ page - 1 }}"
       class="px-4 py-2 font-mono text-xs text-ink/60 border border-ink/15 rounded-xl
              hover:border-terra hover:text-terra transition-colors">‚Üê Zur√ºck</a>
    {% else %}
    <span class="px-4 py-2 font-mono text-xs text-ink/20 border border-ink/8 rounded-xl cursor-not-allowed">‚Üê Zur√ºck</span>
    {% endif %}

    {# Page numbers: show first, window around current, last #}
    {% set window = 2 %}
    {% for p in range(1, total_pages + 1) %}
      {% if p == 1 or p == total_pages or (p >= page - window and p <= page + window) %}
        {% if loop.index > 1 and p > 1 %}
          {# Check if we need an ellipsis gap before this page #}
          {% set prev_p = namespace(val=1) %}
          {% for pp in range(1, total_pages + 1) %}
            {% if pp < p and (pp == 1 or pp == total_pages or (pp >= page - window and pp <= page + window)) %}
              {% set prev_p.val = pp %}
            {% endif %}
          {% endfor %}
          {% if p - prev_p.val > 1 %}
          <span class="font-mono text-xs text-ink/25 px-1">‚Ä¶</span>
          {% endif %}
        {% endif %}
        {% if p == page %}
        <span class="px-4 py-2 font-mono text-xs bg-terra text-cream rounded-xl font-medium">{{ p }}</span>
        {% else %}
        <a href="?{{ base_qs }}{% if base_qs %}&{% endif %}page={{ p }}"
           class="px-4 py-2 font-mono text-xs text-ink/55 border border-ink/15 rounded-xl
                  hover:border-terra hover:text-terra transition-colors">{{ p }}</a>
        {% endif %}
      {% endif %}
    {% endfor %}

    {# Next button #}
    {% if page < total_pages %}
    <a href="?{{ base_qs }}{% if base_qs %}&{% endif %}page={{ page + 1 }}"
       class="px-4 py-2 font-mono text-xs text-ink/60 border border-ink/15 rounded-xl
              hover:border-terra hover:text-terra transition-colors">Weiter ‚Üí</a>
    {% else %}
    <span class="px-4 py-2 font-mono text-xs text-ink/20 border border-ink/8 rounded-xl cursor-not-allowed">Weiter ‚Üí</span>
    {% endif %}

  </nav>
  <div class="text-center font-mono text-[10px] text-ink/25 mb-8">
    {{ (page - 1) * per_page + 1 }}‚Äì{{ [page * per_page, total_filtered] | min }} von {{ total_filtered }} Restaurants
  </div>
  {% endif %}

  {% else %}
  <div class="bg-white rounded-2xl border border-sand p-16 text-center mt-8">
    <div class="font-serif text-7xl mb-4 opacity-10">üèñ</div>
    {% if view == 'want' %}
    <h2 class="font-serif text-2xl font-bold text-ink mb-2">Noch nichts auf der Merkliste</h2>
    <p class="font-sans text-sm text-ink/40">Klick auf ü§ç bei einem Restaurant, um es zu speichern.</p>
    {% elif view == 'been' %}
    <h2 class="font-serif text-2xl font-bold text-ink mb-2">Noch keine besuchten Restaurants</h2>
    <p class="font-sans text-sm text-ink/40">Klick auf ‚óã bei einem Restaurant nach dem Besuch.</p>
    {% elif profile_key %}
    <h2 class="font-serif text-2xl font-bold text-ink mb-2">Keine Treffer</h2>
    <p class="font-sans text-sm text-ink/40">Niedrigeren Mindest-Score w√§hlen oder Profil wechseln.</p>
    {% elif enriched_count == 0 %}
    <h2 class="font-serif text-2xl font-bold text-ink mb-2">Noch keine KI-Analysen</h2>
    <p class="font-sans text-sm text-ink/40 mb-4">Starte den Enricher:</p>
    <code class="block bg-ink text-cream text-xs font-mono rounded-xl p-4 text-left max-w-lg mx-auto">
      docker compose --profile enrich run --rm enricher --limit 10 --dry-run
    </code>
    {% else %}
    <h2 class="font-serif text-2xl font-bold text-ink mb-2">Keine Restaurants gefunden</h2>
    <p class="font-sans text-sm text-ink/40">Andere Suchbegriffe oder Filter versuchen.</p>
    {% endif %}
  </div>
  {% endif %}

</main>

<!-- Footer -->
<footer class="bg-ink text-cream/25 py-5 mt-4">
  <div class="max-w-7xl mx-auto px-5 flex items-center justify-between flex-wrap gap-3">
    <span class="font-mono text-xs">MallorcaEat ¬∑ {{ total }} Restaurants</span>
    <span class="font-serif italic text-cream/20 text-sm">La mejor mesa te espera.</span>
  </div>
</footer>

<!-- ‚ïê‚ïê‚ïê SIMILAR RESTAURANTS MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="sim-modal"
     class="hidden fixed inset-0 z-50 flex items-start justify-center bg-ink/70 backdrop-blur-sm overflow-y-auto py-8 px-4"
     onclick="if(event.target===this)closeSimilar()">
  <div class="bg-cream rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden">

    <!-- Header -->
    <div class="flex items-start justify-between px-6 py-5 border-b border-sand">
      <div>
        <h3 id="sim-title" class="font-serif text-xl font-bold text-ink leading-tight">√Ñhnliche Restaurants</h3>
        <p class="font-mono text-[10px] text-ink/35 uppercase tracking-widest mt-1">basierend auf Profil-Scores &amp; Stimmung</p>
      </div>
      <button onclick="closeSimilar()"
              class="shrink-0 ml-4 w-9 h-9 flex items-center justify-center rounded-full
                     bg-ink/8 text-ink/40 hover:bg-ink/14 transition-colors font-mono text-sm">
        ‚úï
      </button>
    </div>

    <!-- Body -->
    <div class="p-6">

      <!-- Spinner -->
      <div id="sim-spinner" class="flex items-center justify-center py-14">
        <div class="w-8 h-8 border-2 rounded-full animate-spin"
             style="border-color:rgba(196,98,45,.2);border-top-color:#c4622d"></div>
      </div>

      <!-- Mini-card grid (populated by JS) -->
      <div id="sim-grid" class="hidden grid grid-cols-2 sm:grid-cols-3 gap-3"></div>

      <!-- Empty state -->
      <div id="sim-empty" class="hidden text-center py-12">
        <div class="font-serif text-5xl mb-3 opacity-10">üîç</div>
        <p class="font-sans text-sm text-ink/40">Keine √§hnlichen Restaurants gefunden.</p>
      </div>

    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê SCORE POPOVER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="fav-popover"
     class="hidden fixed inset-0 z-50 flex items-center justify-center bg-ink/60 backdrop-blur-sm"
     onclick="if(event.target===this)closeFavPopover()">
  <div class="bg-cream rounded-2xl p-7 max-w-sm w-full mx-4 shadow-2xl">
    <h3 class="font-serif text-xl font-bold text-ink mb-1">Wie war's?</h3>
    <p class="font-sans text-sm text-ink/45 mb-6">Vergib optional eine Wertung auf der 100er-Skala.</p>

    <div class="flex items-center gap-4 mb-2">
      <input type="range" id="fav-slider" min="0" max="100" value="75"
             class="flex-1 accent-terra h-2 cursor-pointer"
             oninput="document.getElementById('fav-val').textContent=this.value">
      <span id="fav-val" class="font-mono text-3xl font-bold text-terra w-14 text-right tabular-nums">75</span>
    </div>
    <div class="flex justify-between font-mono text-[10px] text-ink/25 mb-7 px-0.5">
      <span>0</span><span>25</span><span>50</span><span>75</span><span>100</span>
    </div>

    <div class="flex gap-2">
      <button onclick="saveFav(parseInt(document.getElementById('fav-slider').value))"
              class="flex-1 bg-terra text-cream font-sans text-sm font-medium py-2.5 rounded-xl hover:bg-rust transition-colors">
        Speichern
      </button>
      <button onclick="saveFav(null)"
              class="flex-1 bg-ink/8 text-ink/55 font-sans text-sm py-2.5 rounded-xl hover:bg-ink/12 transition-colors border border-ink/10">
        Ohne Wertung
      </button>
      <button onclick="closeFavPopover()"
              class="w-11 flex items-center justify-center bg-ink/8 text-ink/40 rounded-xl hover:bg-ink/12 transition-colors border border-ink/10">
        ‚úï
      </button>
    </div>
  </div>
</div>

<script>
  /* ‚îÄ‚îÄ Carousel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  function moveC(id, dir) {
    const el = document.getElementById(id);
    if (!el) return;
    const strip = el.querySelector('[data-strip]');
    const dots  = el.querySelectorAll('[data-dots] span');
    const total = strip.children.length;
    let idx = parseInt(el.dataset.idx || '0', 10);
    idx = (idx + dir + total) % total;
    el.dataset.idx = idx;
    strip.style.transform = 'translateX(-' + (idx * 100) + '%)';
    dots.forEach((d, i) => { d.style.opacity = i === idx ? '0.9' : '0.3'; });
  }

  /* ‚îÄ‚îÄ Favorites ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  let _fav = { placeId: null, type: null };

  function toggleFav(evt, placeId, type) {
    evt.stopPropagation();
    const card = document.querySelector(`[data-place-id="${placeId}"]`);
    const current = card ? card.dataset.favType : '';
    if (current === type) {
      // Already this type ‚Üí remove
      _doRemoveFav(placeId);
    } else if (type === 'been') {
      // Show score popover
      _fav = { placeId, type };
      document.getElementById('fav-slider').value = 75;
      document.getElementById('fav-val').textContent = '75';
      document.getElementById('fav-popover').classList.remove('hidden');
    } else {
      // "want" ‚Üí save directly, no score
      _doSaveFav(placeId, type, null);
    }
  }

  function saveFav(score) {
    closeFavPopover();
    _doSaveFav(_fav.placeId, _fav.type, score);
  }

  function closeFavPopover() {
    document.getElementById('fav-popover').classList.add('hidden');
  }

  function _doSaveFav(placeId, type, score) {
    fetch('/api/favorite', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ place_id: placeId, list_type: type, score: score })
    }).then(() => _updateCard(placeId, type, score));
  }

  function _doRemoveFav(placeId) {
    fetch(`/api/favorite/${placeId}`, { method: 'DELETE' })
      .then(() => _updateCard(placeId, null, null));
  }

  /* ‚îÄ‚îÄ Similar restaurants ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  const _simCache = new Map();

  function showSimilar(placeId, name) {
    const modal   = document.getElementById('sim-modal');
    const title   = document.getElementById('sim-title');
    const spinner = document.getElementById('sim-spinner');
    const grid    = document.getElementById('sim-grid');
    const empty   = document.getElementById('sim-empty');

    title.textContent = `√Ñhnlich wie ‚Äû${name}"`;
    spinner.classList.remove('hidden');
    grid.classList.add('hidden');
    grid.innerHTML = '';
    empty.classList.add('hidden');
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';

    if (_simCache.has(placeId)) {
      _renderSimilar(_simCache.get(placeId));
      return;
    }

    fetch(`/api/similar/${placeId}`)
      .then(r => r.json())
      .then(data => {
        _simCache.set(placeId, data);
        _renderSimilar(data);
      })
      .catch(() => {
        spinner.classList.add('hidden');
        empty.classList.remove('hidden');
      });
  }

  function closeSimilar() {
    document.getElementById('sim-modal').classList.add('hidden');
    document.body.style.overflow = '';
  }

  function _simBadge(sim) {
    const pct = Math.round(sim * 100);
    let cls;
    if (pct >= 80)      cls = 'background:#d4edda;color:#1a5c2e';
    else if (pct >= 65) cls = 'background:#fff3cd;color:#7a5500';
    else                cls = 'background:#ebebeb;color:#555';
    return `<span style="font-family:monospace;font-size:10px;font-weight:700;padding:2px 7px;border-radius:9999px;${cls}">${pct}%</span>`;
  }

  function _renderSimilar(items) {
    const spinner = document.getElementById('sim-spinner');
    const grid    = document.getElementById('sim-grid');
    const empty   = document.getElementById('sim-empty');

    spinner.classList.add('hidden');

    if (!items || !items.length) {
      empty.classList.remove('hidden');
      return;
    }

    grid.innerHTML = items.map(r => {
      const photo = r.photo_url
        ? `<img src="${r.photo_url}" alt="" class="w-full h-28 object-cover" loading="lazy" onerror="this.parentNode.innerHTML='<div class=\\'w-full h-28 bg-gradient-to-br from-sand to-stone-100 flex items-center justify-center\\'><span class=\\'text-4xl opacity-20\\'>' + (r ? r.type_emoji : 'üçΩÔ∏è') + '</span></div>'">`
        : `<div class="w-full h-28 bg-gradient-to-br from-sand to-stone-100 flex items-center justify-center"><span class="text-4xl opacity-20">${r.type_emoji}</span></div>`;
      const ratingStr = r.rating ? `‚òÖ ${Math.round(r.rating * 20)}/100` : '';
      const priceStr  = r.price_level ? `<span style="margin-left:auto;font-family:monospace;font-size:10px;color:#0f0e0d55">${r.price_level}</span>` : '';
      const vibeStr   = r.vibe
        ? `<p style="font-size:11px;font-style:italic;color:#0f0e0d66;line-height:1.35;padding:4px 10px 6px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden">${r.vibe.substring(0,90)}${r.vibe.length>90?'‚Ä¶':''}</p>`
        : '';
      return `
        <div onclick="_goToCard('${r.place_id}')"
             style="background:#fff;border-radius:12px;overflow:hidden;border:1px solid #e8e0cc;cursor:pointer;transition:border-color .15s,box-shadow .15s"
             onmouseover="this.style.borderColor='#c4622d50';this.style.boxShadow='0 4px 16px rgba(15,14,13,.1)'"
             onmouseout="this.style.borderColor='#e8e0cc';this.style.boxShadow=''">
          <div style="position:relative">
            ${photo}
            <div style="position:absolute;top:6px;right:6px">${_simBadge(r.similarity)}</div>
          </div>
          <div style="padding:8px 10px 4px">
            <p style="font-family:Georgia,serif;font-size:13px;font-weight:700;color:#0f0e0d;line-height:1.2;overflow:hidden;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical">${r.name}</p>
            <div style="display:flex;align-items:center;gap:6px;margin-top:3px">
              <span style="font-family:monospace;font-size:10px;color:#0f0e0d66">${r.type_emoji} ${ratingStr}</span>
              ${priceStr}
            </div>
          </div>
          ${vibeStr}
        </div>`;
    }).join('');

    grid.classList.remove('hidden');
  }

  function _goToCard(placeId) {
    closeSimilar();
    const card = document.querySelector(`[data-place-id="${placeId}"]`);
    if (card) {
      setTimeout(() => {
        card.scrollIntoView({ behavior: 'smooth', block: 'center' });
        card.style.outline = '3px solid #c4622d';
        card.style.outlineOffset = '3px';
        setTimeout(() => { card.style.outline = ''; card.style.outlineOffset = ''; }, 2000);
      }, 150);
    }
  }

  /* ‚îÄ‚îÄ Close modal on Escape ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  document.addEventListener('keydown', e => {
    if (e.key === 'Escape') {
      closeSimilar();
      closeFavPopover();
    }
  });

  function _updateCard(placeId, type, score) {
    const card = document.querySelector(`[data-place-id="${placeId}"]`);
    if (!card) return;
    card.dataset.favType = type || '';

    const wantBtn  = card.querySelector('[data-fav-btn="want"]');
    const beenBtn  = card.querySelector('[data-fav-btn="been"]');
    const scoreEl  = card.querySelector('[data-fav-score]');

    if (wantBtn) {
      const active = type === 'want';
      wantBtn.innerHTML  = active ? '‚ù§Ô∏è' : 'ü§ç';
      wantBtn.className  = wantBtn.className
        .replace(/bg-\S+|text-\S+/g, '').trim();
      wantBtn.classList.add(...(active
        ? ['bg-terra','text-cream','shadow-md']
        : ['bg-ink/40','text-cream/70','hover:bg-terra/80','hover:text-cream']));
    }
    if (beenBtn) {
      const active = type === 'been';
      beenBtn.innerHTML  = active ? '‚úì' : '‚óã';
      beenBtn.className  = beenBtn.className
        .replace(/bg-\S+|text-\S+/g, '').trim();
      beenBtn.classList.add(...(active
        ? ['bg-sage','text-cream','shadow-md']
        : ['bg-ink/40','text-cream/70','hover:bg-sage/80','hover:text-cream']));
    }
    if (scoreEl) {
      if (type === 'been' && score !== null && score !== undefined) {
        scoreEl.textContent = score;
        scoreEl.classList.remove('hidden');
      } else {
        scoreEl.classList.add('hidden');
      }
    }
  }
</script>

</body>
</html>
