<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MallorcaEat</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;0,900;1,700&family=Inter:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            ink:   '#0f0e0d',
            cream: '#f5f0e8',
            sand:  '#e8e0cc',
            terra: '#c4622d',
            rust:  '#9e3d14',
            sage:  '#3d5a47',
          },
          fontFamily: {
            serif: ['"Playfair Display"', 'Georgia', 'serif'],
            sans:  ['Inter', 'system-ui', 'sans-serif'],
            mono:  ['"DM Mono"', 'monospace'],
          }
        }
      }
    }
  </script>
  <style>
    body { background: #f5f0e8; color: #0f0e0d; }

    .card { transition: transform .2s ease, box-shadow .2s ease; }
    .card:hover { transform: translateY(-3px); box-shadow: 0 16px 40px rgba(15,14,13,.13); }

    .pill { transition: background .15s, color .15s, border-color .15s; }
    .pill.active { background: #f5f0e8; color: #0f0e0d; border-color: #f5f0e8; }

    .score-hi  { background: #d4edda; color: #1a5c2e; }
    .score-mid { background: #fff3cd; color: #7a5500; }
    .score-lo  { background: #ebebeb; color: #555; }
    .score-sel { outline: 2px solid #c4622d; outline-offset: 1px; }

    .filter-scroll { -ms-overflow-style: none; scrollbar-width: none; }
    .filter-scroll::-webkit-scrollbar { display: none; }

    @media (min-width: 1024px) {
      .card-featured { grid-column: span 2; }
      .card-featured .card-img { height: 340px; }
    }
  </style>
</head>
<body class="min-h-screen font-sans">

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<header class="bg-ink text-cream">
  <div class="max-w-7xl mx-auto px-5 pt-10 pb-8">

    <div class="flex items-center justify-between mb-8 border-b border-cream/20 pb-4">
      <span class="font-mono text-xs tracking-widest text-cream/40 uppercase">Restaurant Guide</span>
      <span class="font-mono text-xs text-cream/30">Mallorca ¬∑ Espa√±a</span>
    </div>

    <div class="flex flex-col lg:flex-row lg:items-end lg:justify-between gap-8">
      <div>
        <h1 class="font-serif text-[clamp(3.5rem,11vw,8rem)] leading-[.88] tracking-tight">
          Mallorca<br><em class="text-terra">Eat</em>
        </h1>
        <p class="mt-5 font-sans font-light text-cream/55 text-lg max-w-sm leading-relaxed">
          Die besten Tische der Insel ‚Äî kuratiert, bewertet, ehrlich.
        </p>
      </div>

      <div class="flex gap-8 shrink-0 pb-1">
        <div>
          <div class="font-serif text-5xl font-bold text-cream">{{ top_count }}</div>
          <div class="font-mono text-[10px] text-cream/35 uppercase tracking-widest mt-1">Top Spots</div>
        </div>
        <div class="w-px bg-cream/10"></div>
        <div>
          <div class="font-serif text-5xl font-bold text-terra">{{ enriched_count }}</div>
          <div class="font-mono text-[10px] text-cream/35 uppercase tracking-widest mt-1">KI-analysiert</div>
        </div>
        <div class="w-px bg-cream/10"></div>
        <div>
          <div class="font-serif text-5xl font-bold text-cream">{{ avg_rating }}</div>
          <div class="font-mono text-[10px] text-cream/35 uppercase tracking-widest mt-1">√ò Bewertung</div>
        </div>
      </div>
    </div>
  </div>
</header>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STICKY NAV FILTER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="bg-ink border-t border-cream/10 sticky top-0 z-30">
  <div class="max-w-7xl mx-auto px-5">
    <div class="filter-scroll flex gap-2 overflow-x-auto py-3">
      <a href="{{ url_for('index', search=search, location=location) }}"
         class="pill shrink-0 border border-cream/20 rounded-full px-4 py-1.5 font-mono text-xs text-cream/50 hover:border-cream/50 {{ 'active' if not profile_key else '' }}">
        Alle
      </a>
      {% for key, emoji, label in profiles %}
      <a href="{{ url_for('index', search=search, location=location, profile=key, min_score=min_score) }}"
         class="pill shrink-0 border border-cream/20 rounded-full px-4 py-1.5 font-mono text-xs text-cream/50 hover:border-cream/50 {{ 'active' if profile_key == key else '' }}">
        {{ emoji }}&nbsp;{{ label }}
      </a>
      {% endfor %}
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SEARCH + SCORE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="max-w-7xl mx-auto px-5 mt-5 flex flex-wrap items-center gap-3">

  {% if profile_key %}
  <div class="flex items-center gap-1.5 bg-white rounded-xl px-3 py-2 shadow-sm border border-sand">
    <span class="font-mono text-[10px] text-ink/35 uppercase tracking-widest mr-1">Score ‚â•</span>
    {% for s in [6, 7, 8, 9] %}
    <a href="{{ url_for('index', search=search, location=location, profile=profile_key, min_score=s) }}"
       class="font-mono text-xs px-2.5 py-1 rounded-lg transition
              {{ 'bg-ink text-cream' if min_score == s else 'text-ink/40 hover:bg-sand' }}">
      {{ s }}
    </a>
    {% endfor %}
  </div>
  {% endif %}

  <form method="get" class="flex flex-1 min-w-[200px] items-center gap-2 bg-white rounded-xl px-3 py-2 shadow-sm border border-sand">
    {% if profile_key %}<input type="hidden" name="profile" value="{{ profile_key }}">{% endif %}
    {% if min_score != 7 %}<input type="hidden" name="min_score" value="{{ min_score }}">{% endif %}
    <span class="text-ink/25 text-base">‚åï</span>
    <input type="text" name="search" value="{{ search }}"
           placeholder="Restaurant suchen ‚Ä¶"
           class="flex-1 text-sm font-sans outline-none bg-transparent placeholder-ink/25">
    {% if locations %}
    <select name="location" class="text-sm font-sans text-ink/50 bg-transparent outline-none border-l border-sand pl-3">
      <option value="">Alle Orte</option>
      {% for loc in locations %}
      <option value="{{ loc }}" {% if loc == location %}selected{% endif %}>{{ loc }}</option>
      {% endfor %}
    </select>
    {% endif %}
    <button type="submit"
            class="bg-terra text-cream font-mono text-xs px-3 py-1.5 rounded-lg hover:bg-rust transition shrink-0">
      Los
    </button>
    {% if search or location %}
    <a href="{{ url_for('index', profile=profile_key or '', min_score=min_score) }}"
       class="text-ink/25 hover:text-ink/60 text-sm px-1">‚úï</a>
    {% endif %}
  </form>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MAIN GRID ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<main class="max-w-7xl mx-auto px-5 py-6 pb-20">

  {% if error %}
  <div class="bg-red-50 border border-red-200 rounded-2xl p-10 text-center">
    <div class="font-serif text-5xl mb-3 text-red-300">!</div>
    <h2 class="font-serif text-xl font-bold text-red-700">Datenbankfehler</h2>
    <pre class="mt-3 text-sm text-red-500 bg-red-100 rounded-xl p-4 text-left overflow-x-auto font-mono">{{ error }}</pre>
  </div>

  {% elif restaurants %}

  <!-- Count / filter label -->
  <div class="flex items-center gap-4 mb-6 pt-2">
    <div class="flex-1 border-t border-ink/10"></div>
    <span class="font-mono text-[11px] text-ink/35 uppercase tracking-widest whitespace-nowrap">
      {{ restaurants|length }} Restaurant{% if restaurants|length != 1 %}s{% endif %}
      {% if profile_key %}{% for k, e, l in profiles %}{% if k == profile_key %} ¬∑ {{ e }} {{ l }} ‚â• {{ min_score }}{% endif %}{% endfor %}{% endif %}
      {% if search %} ¬∑ ‚Äû{{ search }}"{% endif %}
    </span>
    <div class="flex-1 border-t border-ink/10"></div>
  </div>

  <!-- Cards -->
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5">
    {% for r in restaurants %}

    {% set scores = [
      ("family",    "üë®‚Äçüë©‚Äçüëß", "Familie",    r.family_score),
      ("date",      "üíë",    "Date Night", r.date_score),
      ("friends",   "üëØ",    "Friends",    r.friends_score),
      ("solo",      "üßç",    "Solo",       r.solo_score),
      ("relaxed",   "üòå",    "Entspannt",  r.relaxed_score),
      ("party",     "üéâ",    "Party",      r.party_score),
      ("special",   "‚ú®",    "Besonders",  r.special_score),
      ("foodie",    "üçΩÔ∏è",   "Foodie",     r.foodie_score),
      ("lingering", "‚òï",    "Verweilen",  r.lingering_score),
      ("unique",    "üíé",    "Geheimtipp", r.unique_score),
      ("dresscode", "üëî",    "Dress Code", r.dresscode_score),
    ] %}

    <div class="card group bg-white rounded-2xl overflow-hidden flex flex-col border border-sand {{ 'card-featured' if loop.first else '' }}">

      <!-- Image carousel -->
      <div class="card-img relative h-52 overflow-hidden bg-gradient-to-br from-sand to-stone-100 group" id="c{{ loop.index }}" data-idx="0">
        <!-- Emoji fallback ‚Äî always rendered behind photos, visible when images fail or are absent -->
        <div class="absolute inset-0 flex items-center justify-center pointer-events-none select-none z-0">
          <span class="text-7xl opacity-20">{{ r.type_emoji }}</span>
        </div>

        {% if r.photos %}
        <!-- Photo strip: all images in a flex row, JS moves translateX -->
        <div class="flex h-full relative z-10" data-strip style="transition:transform .3s ease">
          {% for photo in r.photos %}
          <img src="{{ photo }}" alt="{{ r.name }}"
               class="shrink-0 object-cover"
               style="min-width:100%;width:100%"
               loading="lazy"
               onerror="this.style.display='none'">
          {% endfor %}
        </div>

        {% if r.photos|length > 1 %}
        <!-- Prev arrow -->
        <button onclick="moveC('c{{ loop.index }}',-1);event.stopPropagation()"
                class="absolute left-2 top-1/2 -translate-y-1/2
                       w-7 h-7 rounded-full bg-ink/55 text-cream text-base leading-none
                       flex items-center justify-center
                       opacity-0 group-hover:opacity-100 transition-opacity
                       hover:bg-ink/80 focus:outline-none z-20">
          ‚Äπ
        </button>
        <!-- Next arrow -->
        <button onclick="moveC('c{{ loop.index }}',1);event.stopPropagation()"
                class="absolute right-2 top-1/2 -translate-y-1/2
                       w-7 h-7 rounded-full bg-ink/55 text-cream text-base leading-none
                       flex items-center justify-center
                       opacity-0 group-hover:opacity-100 transition-opacity
                       hover:bg-ink/80 focus:outline-none z-20">
          ‚Ä∫
        </button>
        <!-- Dot indicators -->
        <div class="absolute bottom-2 left-1/2 -translate-x-1/2 flex gap-1 pointer-events-none z-20" data-dots>
          {% for photo in r.photos %}
          <span class="block w-1.5 h-1.5 rounded-full bg-white transition-opacity
                       {% if loop.first %}opacity-90{% else %}opacity-30{% endif %}"></span>
          {% endfor %}
        </div>
        {% endif %}
        {% endif %}

        {% if r.price_level %}
        <span class="absolute top-3 right-3 font-mono text-xs bg-ink/75 text-cream px-2.5 py-0.5 rounded-full backdrop-blur-sm z-20">{{ r.price_level }}</span>
        {% endif %}
      </div>
      {% if false %}{# old else branch kept for reference ‚Äî now unused #}
      <div class="card-img h-52 bg-gradient-to-br from-sand to-cream flex items-center justify-center relative">
        <span class="text-5xl opacity-30">üçΩÔ∏è</span>
        {% if r.price_level %}
        <span class="absolute top-3 right-3 font-mono text-xs bg-ink text-cream px-2 py-0.5 rounded-full">{{ r.price_level }}</span>
        {% endif %}
      </div>
      {% endif %}

      <!-- Body -->
      <div class="p-5 flex flex-col flex-1">

        <!-- Name + rating -->
        <div class="flex items-start justify-between gap-2 mb-2">
          <h3 class="font-serif text-xl font-bold text-ink leading-tight">{{ r.name }}</h3>
          <div class="shrink-0 flex items-center gap-1 bg-ink text-cream rounded-full pl-2.5 pr-2.5 py-0.5">
            <span class="font-mono text-xs font-bold
              {% if (r.rating * 20)|round|int >= 94 %}text-green-400
              {% elif (r.rating * 20)|round|int >= 88 %}text-terra
              {% else %}text-cream/70{% endif %}">
              {{ (r.rating * 20)|round|int }}
            </span>
            <span class="font-mono text-[9px] text-cream/35">/100</span>
          </div>
        </div>

        <!-- City ¬∑ type ¬∑ review count -->
        <div class="flex items-center gap-2 flex-wrap mb-3">
          {% if r.city %}
          <span class="font-mono text-[10px] text-ink/45 flex items-center gap-0.5">
            <svg class="inline w-2.5 h-2.5 opacity-50 shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/></svg>
            {{ r.city }}
          </span>
          {% endif %}
          <span class="font-mono text-[10px] text-terra/70 border border-terra/20 bg-terra/5 px-2 py-0.5 rounded-full leading-none">{{ r.type_emoji }} {{ r.type_label }}</span>
          <span class="font-mono text-[10px] text-ink/25 ml-auto">{{ r.rating_count | int }} ‚ú¶</span>
        </div>

        <!-- Vibe -->
        {% if r.vibe %}
        <p class="font-sans text-xs italic text-ink/50 leading-snug mb-3 line-clamp-2">‚Äû{{ r.vibe }}"</p>
        {% endif %}

        <!-- Atmosphere + highlight tags (SerpAPI) -->
        {% if r.atmosphere or r.highlights %}
        <div class="flex flex-wrap gap-1 mb-3">
          {% for tag in (r.atmosphere or [])[:3] %}
          <span class="font-mono text-[10px] text-ink/45 bg-sand/50 border border-sand px-2 py-0.5 rounded-full">{{ tag }}</span>
          {% endfor %}
          {% for tag in (r.highlights or [])[:2] %}
          <span class="font-mono text-[10px] text-sage/80 border border-sage/20 bg-sage/5 px-2 py-0.5 rounded-full">‚ú¶ {{ tag }}</span>
          {% endfor %}
        </div>
        {% elif r.categories %}
        <div class="flex flex-wrap gap-1 mb-3">
          {% for cat in r.categories[:3] %}
          <span class="font-mono text-[10px] uppercase tracking-wide text-terra/70 border border-terra/15 px-2 py-0.5 rounded-full">{{ cat }}</span>
          {% endfor %}
        </div>
        {% endif %}

        <!-- Profile scores -->
        {% if r.vibe %}
        <div class="flex flex-wrap gap-1 mb-3">
          {% for key, emoji, label, score in scores %}
          {% if score %}
          <span title="{{ label }}: {{ score }}/10"
                class="font-mono text-[10px] px-2 py-0.5 rounded-full font-medium
                       {{ 'score-hi' if score >= 8 else 'score-mid' if score >= 6 else 'score-lo' }}
                       {{ 'score-sel' if profile_key == key }}">
            {{ emoji }} {{ score }}
          </span>
          {% endif %}
          {% endfor %}
        </div>

        <!-- Must order -->
        {% if r.must_order %}
        <div class="flex items-start gap-1.5 mb-2">
          <span class="text-terra text-xs shrink-0 mt-0.5">üç¥</span>
          <p class="font-sans text-xs text-ink/60 leading-snug">{{ r.must_order }}</p>
        </div>
        {% endif %}

        <!-- Collapsible: summary + popular_for + offerings -->
        {% if r.summary_de or r.popular_for or r.offerings %}
        <details class="mt-1 group">
          <summary class="font-mono text-[10px] uppercase tracking-widest text-terra/70 cursor-pointer hover:text-terra select-none list-none flex items-center gap-1">
            <span class="group-open:hidden">‚ñ∏ Mehr erfahren</span>
            <span class="hidden group-open:inline">‚ñæ Weniger</span>
          </summary>
          <div class="mt-2 space-y-2">
            {% if r.summary_de %}
            <p class="font-sans text-xs text-ink/55 leading-relaxed border-l-2 border-terra/25 pl-3">{{ r.summary_de }}</p>
            {% endif %}
            {% if r.popular_for %}
            <div class="flex flex-wrap gap-1">
              {% for t in r.popular_for %}
              <span class="font-mono text-[10px] bg-cream border border-sand px-2 py-0.5 rounded-full text-ink/55">üïê {{ t }}</span>
              {% endfor %}
            </div>
            {% endif %}
            {% if r.offerings %}
            <div class="flex flex-wrap gap-1">
              {% for t in (r.offerings or [])[:8] %}
              <span class="font-mono text-[10px] bg-cream border border-sand px-2 py-0.5 rounded-full text-ink/55">üçπ {{ t }}</span>
              {% endfor %}
            </div>
            {% endif %}
          </div>
        </details>
        {% endif %}
        {% endif %}

        <div class="flex-1"></div>

        <!-- Footer -->
        <div class="mt-4 pt-3 border-t border-sand flex items-center justify-between gap-2 flex-wrap">
          {% if r.address %}
          <p class="font-mono text-[10px] text-ink/30 leading-snug flex-1 min-w-0 truncate">
            üìç {{ r.address.split(',')[0] }}
          </p>
          {% endif %}
          <div class="flex gap-3 shrink-0">
            {% if r.website %}
            <a href="{{ r.website }}" target="_blank" rel="noopener"
               class="font-mono text-[10px] text-terra hover:text-rust uppercase tracking-wide">Web ‚Üó</a>
            {% endif %}
          </div>
        </div>

      </div>
    </div>
    {% endfor %}
  </div>

  {% else %}
  <div class="bg-white rounded-2xl border border-sand p-16 text-center mt-8">
    <div class="font-serif text-7xl mb-4 opacity-10">üèñ</div>
    {% if profile_key %}
    <h2 class="font-serif text-2xl font-bold text-ink mb-2">Keine Treffer</h2>
    <p class="font-sans text-sm text-ink/40">Niedrigeren Mindest-Score w√§hlen oder Profil wechseln.</p>
    {% elif enriched_count == 0 %}
    <h2 class="font-serif text-2xl font-bold text-ink mb-2">Noch keine KI-Analysen</h2>
    <p class="font-sans text-sm text-ink/40 mb-4">Starte den Enricher:</p>
    <code class="block bg-ink text-cream text-xs font-mono rounded-xl p-4 text-left max-w-lg mx-auto">
      docker compose --profile enrich run --rm enricher --limit 10 --dry-run
    </code>
    {% else %}
    <h2 class="font-serif text-2xl font-bold text-ink mb-2">Keine Restaurants gefunden</h2>
    <p class="font-sans text-sm text-ink/40">Andere Suchbegriffe oder Filter versuchen.</p>
    {% endif %}
  </div>
  {% endif %}

</main>

<!-- Footer -->
<footer class="bg-ink text-cream/25 py-5 mt-4">
  <div class="max-w-7xl mx-auto px-5 flex items-center justify-between flex-wrap gap-3">
    <span class="font-mono text-xs">MallorcaEat ¬∑ {{ total }} Restaurants</span>
    <span class="font-serif italic text-cream/20 text-sm">La mejor mesa te espera.</span>
  </div>
</footer>

<script>
  function moveC(id, dir) {
    const el = document.getElementById(id);
    if (!el) return;
    const strip = el.querySelector('[data-strip]');
    const dots  = el.querySelectorAll('[data-dots] span');
    const total = strip.children.length;
    let idx = parseInt(el.dataset.idx || '0', 10);
    idx = (idx + dir + total) % total;
    el.dataset.idx = idx;
    strip.style.transform = 'translateX(-' + (idx * 100) + '%)';
    dots.forEach((d, i) => { d.style.opacity = i === idx ? '0.9' : '0.3'; });
  }
</script>

</body>
</html>
